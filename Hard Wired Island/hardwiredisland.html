<script type="text/worker">

const debug      = {
  scriptLoad:    "color: #660066; background-color: white; font-weight: bold;", 
  toggleHarm: "color: white; background-color: #660066",
  themeSwitcher: "color: white; background-color: green", 
  resetRoller: "color: white; background-color: #000066", 
//  calcDieRoll:   "color: white;   background-color: #660066"
};

if (debug.scriptLoad) { console.log("%c Starting custom WEB WORKER scripts", debug.scriptLoad); }

const num_themes = 12;

function calcDieRoll(
           roll_stat, roll_stat_value, 
           roll_dice, roll_adv, roll_disad, roll_bonus, 
           roll_adjust, 
           roll_harm_1, roll_harm_2, 
           roll_harm_3, roll_harm_4, 
           roll_harm_5, roll_harm_6
        ) {
  let roll_formula = "";

  if(debug.calcDieRoll) {
    console.log("%c roll_stat"       + roll_stat,       debug.calcDieRoll);
    console.log("%c roll_stat_value" + roll_stat_value, debug.calcDieRoll);
    console.log("%c roll_dice"       + roll_dice,       debug.calcDieRoll);
    console.log("%c roll_adv"        + roll_adv,        debug.calcDieRoll);
    console.log("%c roll_disad"      + roll_disad,      debug.calcDieRoll);
    console.log("%c roll_bonus"      + roll_bonus,      debug.calcDieRoll);
    console.log("%c roll_adjust"     + roll_adjust,     debug.calcDieRoll);
    console.log("%c roll_harm_1"     + roll_harm_1,     debug.calcDieRoll);
    console.log("%c roll_harm_2"     + roll_harm_2,     debug.calcDieRoll);
    console.log("%c roll_harm_3"     + roll_harm_3,     debug.calcDieRoll);
    console.log("%c roll_harm_4"     + roll_harm_4,     debug.calcDieRoll);
    console.log("%c roll_harm_5"     + roll_harm_5,     debug.calcDieRoll);
    console.log("%c roll_harm_6"     + roll_harm_6,     debug.calcDieRoll);
  }

  if (roll_harm_5) { roll_dice += -1; }
  
  let net_modifier = roll_adv + roll_disad;
  
  if (net_modifier < 0) {
    roll_formula += roll_dice + - net_modifier;
    roll_formula += "d6";
    roll_formula += "dh" + - net_modifier;
    roll_formula += "[Disadvantage " + - net_modifier + "]";
  } else if (net_modifier > 0) {
    roll_formula += roll_dice + net_modifier;
    roll_formula += "d6";
    roll_formula += "dl" + net_modifier;
    roll_formula += "[Advantage " + net_modifier + "]";
  } else {
    roll_formula += roll_dice;
    roll_formula += "d6";
  }

  if (roll_stat !== "none") {
    roll_formula += "+" + roll_stat_value;
    roll_formula += "[" + roll_stat + "]";
  }
  
  if (roll_bonus > 0) { 
    roll_formula += "+" + roll_bonus;
    roll_formula += "[Bonus]";
  } else if (roll_bonus < 0) {
    roll_formula += roll_bonus;
    roll_formula += "[Bonus]";
  }
  
  if (roll_harm_3 && roll_harm_4) {
    roll_formula += "-2";
    roll_formula += "[Harm]";
  } else if (roll_harm_3) { // and not harm_4, implied
    roll_formula += "-1";
    roll_formula += "[Harm 3]";
  } else if (roll_harm_4) { // and not harm_5, implied
    roll_formula += "-1";
    roll_formula += "[Harm 4]";
  }

  if (roll_adjust > 0) {
    roll_formula += "+";
    roll_formula += roll_adjust;
    roll_formula += "[Adjust]";
  } else if (roll_adjust < 0) {
    roll_formula += roll_adjust;
    roll_formula += "[Adjust]";
  }

  return roll_formula;
}

function toInt(value) { return parseInt(value, 10) || 0; }
function toBoolean(value) { 
  if ( value ==  1     || 
       value == "1"    || 
       value == "true" || 
       value == true  
       ) { return true } else { return false }
}

function toggleHarm(harm) {
  let attributesToGet = [ harm ];
  getAttrs(attributesToGet, function(v) {
    let value = toBoolean(v[harm]);
    let setObj = {};
    if (value) { setObj[harm] = "0" } else { setObj[harm] = "1" }
    setAttrs(setObj);
    if (debug.toggleHarm) { console.log("%c Toggling " + harm, debug.toggleHarm) }
  })
}
        
on("clicked:harm1", function(e) { toggleHarm("harm1") } )
on("clicked:harm2", function(e) { toggleHarm("harm2") } )
on("clicked:harm3", function(e) { toggleHarm("harm3") } )
on("clicked:harm4", function(e) { toggleHarm("harm4") } )
on("clicked:harm5", function(e) { toggleHarm("harm5") } )
on("clicked:harm6", function(e) { toggleHarm("harm6") } )
     
on("clicked:themeright", function(event) {
     let attributesToGet = [ "theme" ];
     getAttrs(attributesToGet, function(v) {
       let oldTheme = v.theme;
       let newTheme = oldTheme + 1;
       if(newTheme >= num_themes) { newTheme = 0 }
       let setObj   = {};
       setObj.theme = newTheme;
       setAttrs(setObj);
       if (debug.themeSwitcher) { console.log("%c Switched from theme #" +
                                              oldTheme + " to #" + newTheme,
                                              debug.themeSwitcher); }
     })
});

on("clicked:themeleft", 
   function(event) {
     let attributesToGet = [ "theme" ];
     getAttrs(attributesToGet, 
       function(v) {
         let oldTheme = v.theme;
         let newTheme = oldTheme - 1;
         if (newTheme < 0) { newTheme = num_themes - 1 }
         let setObj   = {};
         setObj.theme = newTheme;
         setAttrs(setObj);
       if (debug.themeSwitcher) { console.log("%c Switched from theme #" +
                                              oldTheme + " to #" + newTheme,
                                              debug.themeSwitcher); }
       }
    )
  }
);

on("clicked:themerandom", 
   function(event) {
      let newTheme = Math.floor(Math.random() * num_themes);
      let setObj = {};
      setObj.theme = newTheme;
      setAttrs(setObj);
       if (debug.themeSwitcher) { console.log("%c Switched to random theme #" 
                                              + newTheme, debug.themeSwitcher); }
   }
);

on("clicked:reset_roller",
  function(event) {
    let setObj = {};
    setObj.roller_ability = "none";
    setObj.roller_dice = "2";
    setObj.roller_advantage = "0";
    setObj.roller_disadvantage = "0";
    setObj.roller_bonus = "0";
    setObj.roller_adjust = "0";
    setAttrs(setObj);
    if (debug.resetRoller) { console.log("%c Roller reset.", debug.resetRoller) }
  });
    
    
on("sheet:opened" 
   + " change:cool_skill change:clever_skill change:tough_skill change:quick_skill"
   + " change:roller_ability change:roller_dice"
   + " change:roller_advantage change:roller_disadvantage"
   + " change:roller_bonus change:roller_adjust"
   + " change:harm1 change:harm2"
   + " change:harm3 change:harm4"
   + " change:harm5 change:harm6"
   + " change:show_harm",
   
   function(event) {
     let attributesToGet = [ 
           "cool_skill", "clever_skill", "tough_skill", "quick_skill",
           "roller_ability", "roller_dice", "roller_advantage", "roller_disadvantage",
           "roller_bonus", "roller_adjust",
           "harm1", "harm2", "harm3", "harm4", "harm5", "harm6",
           "show_harm"
        ];
                        
     getAttrs(attributesToGet, function(v) {
       let stat       = v.roller_ability;
       let stat_value = 0;
       switch(stat) {
         case "Cool":   stat_value = toInt(v.cool_skill  ); break;
         case "Clever": stat_value = toInt(v.clever_skill); break;
         case "Tough":  stat_value = toInt(v.tough_skill ); break;
         case "Quick":  stat_value = toInt(v.quick_skill ); break;
         case "none":   stat_value = 0;                     break;
       } // switch
       
       let dice   = toInt(v.roller_dice);
       let adv    = toInt(v.roller_advantage);
       let disad  = toInt(v.roller_disadvantage);
       let bonus  = toInt(v.roller_bonus);
       let adjust = toInt(v.roller_adjust);
       let show_harm = toBoolean(v.show_harm);
       let harm1  = show_harm && toBoolean(v.harm1);
       let harm2  = show_harm && toBoolean(v.harm2);
       let harm3  = show_harm && toBoolean(v.harm3);
       let harm4  = show_harm && toBoolean(v.harm4);
       let harm5  = show_harm && toBoolean(v.harm5);
       let harm6  = show_harm && toBoolean(v.harm6);
       
       let roll_formula = calcDieRoll(
                            stat, stat_value, dice, adv, disad, 
                            bonus, adjust, harm1, harm2, 
                            harm3, harm4, harm5, harm6 );
       
       let setObj = {};
       setObj.roll_formula = roll_formula;
       setAttrs(setObj);
    
     }); // getAttrs
            
}); // on

if (debug.scriptLoad) { console.log("%c Custom WEB WORKER script successfully loaded", debug.scriptLoad); }
</script>

<input type="hidden" id="theme" class="theme"      name="attr_theme" />
<input type="hidden" id="config_replace_dropdowns" name="attr_roller_style"     />
<input type="hidden" id="config_roller_preview"    name="attr_roller_preview"   />
<input type="hidden" id="config_preview_editable"  name="attr_preview_editable" />
<input type="hidden" id="config_show_harm"         name="attr_show_harm"        />
<input type="hidden" id="toggle_harm1"             name="attr_harm1" />
<input type="hidden" id="toggle_harm2"             name="attr_harm2" />
<input type="hidden" id="toggle_harm3"             name="attr_harm3" />
<input type="hidden" id="toggle_harm4"             name="attr_harm4" />
<input type="hidden" id="toggle_harm5"             name="attr_harm5" />
<input type="hidden" id="toggle_harm6"             name="attr_harm6" />
    
<div id="everything">

    <header>
        
        <div id="theme_selector" >
          <button type="action" name="act_themeleft"   title="Change the theme">[</button>
          <button type="action" name="act_themerandom" title="Change the theme">;</button>
          <button type="action" name="act_themeright"  title="Change the theme">]</button>
        </div>
        
        <h1 id="pagetitle" data-i18n="hard-wired-island">Hard Wired Island</h1>
        
        <details id="config">
            <summary>y</summary>
            
            <div id="config_theme">
                <button type="action" name="act_themeleft"   title="Change the theme">[</button>
                <span class="var-theme-name" />
                <button type="action" name="act_themeright"  title="Change the theme">]</button>
                <button type="action" name="act_themerandom" title="Change the theme">;</button>
            </div>
            
    
            <div id="show_preview_toggle" class="config_toggle">
                <label for="attr_roller_preview">
                <input type="checkbox" value="1" name="attr_roller_preview" />
                <span>Roller preview</span>
                </label>
            </div>
    
            <div id="nu_roller_style_toggle" class="config_toggle">
                <label for="attr_roller_style">
                <input type="checkbox" value="1" name="attr_roller_style" />
                <span>Replace dice dropdowns with number fields</span>
                </label>
            </div>
            
            <div id="preview_editable_toggle" class="config_toggle">
                <label for="attr_preview_editable">
                <input type="checkbox" value="1" name="attr_preview_editable" />
                <span>Make preview editable</span>
                </label>
            </div>
            
            <div id="show_harm_toggle" class="config_toggle">
                <label for="attr_show_harm">
                <input type="checkbox" value="1" name="attr_show_harm" />
                <span>Include harm in dice rolls</span>
                </label>
            </div>
          
        </details>
        
        <details id="nu_roller">
        
            <summary>
              <div class="open" data-i18n="diceroller-hide">
                Hide Dice Roller
              </div>
              <div class="closed" data-i18n="diceroller-show">
                Show Dice Roller
              </div>
            </summary>
        
                
            <div id="nu_roller_ability">
                <select id="roller_ability" name="attr_roller_ability">
                    <option value="Cool"   data-i18n="cool">Cool</option>
                    <option value="Clever" data-i18n="clever">Clever</option>
                    <option value="Tough"  data-i18n="tough">Tough</option>
                    <option value="Quick"  data-i18n="quick">Quick</option>
                    <option value="none"   data-i18n="none">None</option>
                </select>
                <label for="attr_roller_ability" data-i18n="ability-nc">Ability</label>
            </div>
            
            <div id="nu_roller_number" class="dropdown_replace">
                <select class="number_of_dice roller_style_true" name="attr_roller_dice">
                    <option value="0">0000</option>
                    <option value="1">A000</option>
                    <option value="2" selected=true>AB00</option>
                    <option value="3">ABC0</option>
                    <option value="4">ABCD</option>
                </select>
                <input type="number" class="number_of_dice roller_style_false"
                name="attr_roller_dice" value="2" />
                <label for="attr_roller_dice" data-i18n="dice-to-roll">Dice to Roll</label>
            </div>
                
            <div id="nu_roller_advantage" class="dropdown_replace">
                <select class="number_of_dice roller_style_true" name="attr_roller_advantage">
                    <option value="3">ABC</option>
                    <option value="2">AB0</option>
                    <option value="1">A00</option>
                    <option value="0" selected=true>000</option>
                </select>
                <input type="number" class="number_of_dice roller_style_false"
                name="attr_roller_advantage" />
                <label for="attr_roller_advantage" data-i18n="advantage-nc">Advantage</label>
            </div>
                
            <div id="nu_roller_disadvantage" class="dropdown_replace">
                <select class="number_of_dice roller_style_true" name="attr_roller_disadvantage">
                    <option value="0" selected=true>000</option>
                    <option value="-1">00a</option>
                    <option value="-2">0ab</option>
                    <option value="-3">abc</option>
                </select>
                <input type="number" class="number_of_dice roller_style_false"
                name="attr_roller_disadvantage" />
                <label for="attr_roller_advantage" data-i18n="disadvantage-nc">Disadvantage</label>
            </div>
                
            <div id="nu_roller_bonus" class="dropdown_replace"> 
                <select id="roller_bonus" name="attr_roller_bonus" class="number_of_dice roller_style_true">
                    <option value="3">ABC</option>
                    <option value="2">AB0</option>
                    <option value="1">A00</option>
                    <option value="0" selected=true>000</option>
                    <option value="-1">00a</option>
                    <option value="-2">0ab</option>
                    <option value="-3">abc</option>
                </select>
                <input type="number" class="number_of_dice roller_style_false" name="attr_roller_bonus" />
                <label for="attr_roller_bonus" data-i18n="bonus-nc">Bonus</label>
            </div>
            
            <div id="nu_roller_harm">
                <div id="harm_dots_container">
                    <button type="action" name="act_harm1">0</button>
                    <button type="action" name="act_harm2">0</button>
                    <button type="action" name="act_harm3">0</button>
                    <button type="action" name="act_harm4">0</button>
                    <button type="action" name="act_harm5">0</button>
                    <button type="action" name="act_harm6">0</button>
                </div>
                
                <label for="harm" data-i18n="harm">Harm</label>
            </div>
            
            <div id="nu_roller_adjust">
                <input type="number" name="attr_roller_adjust" class="static_bonus" />
                <label for="attr_roller_adjust" data-i18n="adjust">Adjust</label>
            </div>
                
            <div id="nu_roller_buttons">
                <button type="roll" value="/roll @{roll_formula}" name="roll_from_formula">
                Roll!
                </button>
                <button id="reset_roller" type="action" name="act_reset_roller">Reset</button>
                &nbsp;
            </div>
                        
            <div id="nu_roller_preview">
                <input type="text" class="readonly" name="attr_roll_formula" readonly="true" />
                <input type="text" class="editable" name="attr_roll_formula" />
            </div>
    
        </details>
    </header>
    <main>
        <div class="col2">
        
            <section class="profile-section">
                <div class="row">
                  <label for="name">
                    <span class="input-label" data-i18n="character">Character:</span> 
                    <input id="name" type="text" name="attr_name"/>
                  </label>
                </div>
                <div class="row">
                  <label for="handle">
                    <span class="input-label" data-i18n="handle">Handle:</span> 
                    <input id="handle" type="text" name="attr_handle"/>
                  </label> 
                  <label for="pronouns">
                    <span class="input-label" data-i18n="pronouns">Pronouns:</span> 
                    <input id="pronouns" type="text" name="attr_pronouns"/>
                  </label>
                </div>
                <div class="row">
                  <label for="player">
                    <span class="input-label" data-i18n="player">Player:</span> 
                    <input id="player" type="text" name="attr_player"/>
                  </label>
                </div>
            </section>
            
            <section class="background-section">
                <div class="row">
                  <label for="origin">
                    <span class="input-label" data-i18n="origin">Origin:</span> 
                    <input id="origin" type="text" name="attr_origin"/>
                  </label>
                </div>
                <div class="row">
                  <label for="occupation">
                    <span class="input-label" data-i18n="occupation">Occupation:</span> 
                    <input id="occupation" type="text" name="attr_occupation"/>
                  </label>
                </div>
                <div class="row">
                  <label for="burden">
                    <span class="input-label" data-i18n="burden">Burden:</span> 
                    <input id="burden" type="text" name="attr_burden"/>
                  </label>
                </div>
                <div class="row">
                  <label for="app">
                    <span class="input-label" data-i18n="app">App:</span> 
                    <input id="app" type="text" name="attr_app"/>
                  </label>
                </div>
            </section>
            
            <section class="prep-section column-section">
                <label for="prep" class="column-label" data-i18n="personal prep">Personal Prep</label>
                <div>
                  <input id="prep" type="number" min="0" name="attr_prep"/>
                </div>
            </section>
            
            <section class="attributes-section">
                <table id="attributes-table">
                    <tr>
                      <td></td>
                      <th data-i18n="skill">Skill</th>
                      <th data-i18n="defense">Defense</th>
                    </tr>
                    <tr>
                      <th data-i18n="cool">Cool</th>
                      <td><input type="text" name="attr_cool_skill"/></td>
                      <td><input id="cool_defense" type="text" name="attr_cool_defense"/></td>
                    </tr>
                    <tr>
                      <th data-i18n="clever">Clever</th>
                      <td><input type="text" name="attr_clever_skill"/></td>
                      <td><input id="clever_defense" type="text" name="attr_clever_defense"/></td>
                    </tr>
                    <tr>
                      <th data-i18n="tough">Tough</th>
                      <td><input id="tough" type="text" name="attr_tough_skill"/></td>
                      <td><input id="tough_defense" type="text" name="attr_tough_defense"/></td>
                    </tr>
                    <tr>
                      <th data-i18n="quick">Quick</th>
                      <td><input id="quick" type="text" name="attr_quick_skill"/></td>
                      <td><input id="quick_defense" type="text" name="attr_quick_defense"/></td>
                    </tr>
                </table>
            </section>
            
            <section class="harm-section column-section">
                <label class="column-label" data-i18n="harm">Harm</label>
                <label class="harm-box">
                  <input id="harm-1" type="checkbox" name="attr_harm1" value="1"/>
                  <span  class="number-label" data-i18n="1">1</span>
                  <span  class="harm-label"   data-i18n="minor-injury">Minor Injury</span>
                  <span  class="harm-desc"    data-i18n="no-effect">No effect</span>
                </label>
                <label class="harm-box">
                  <input id="harm-2" type="checkbox" name="attr_harm2" value="1"/>
                  <span class="number-label" data-i18n="2">2</span>
                  <span class="harm-label"   data-i18n="minor-injury">Minor Injury</span>
                  <span class="harm-desc"    data-i18n="no-effect">No effect</span>
                </label>
                <label class="harm-box">
                  <input id="harm-3" type="checkbox" name="attr_harm3" value="1"/>
                  <span class="number-label" data-i18n="3">3</span>
                  <span class="harm-label"   data-i18n="harm">Harm</span>
                  <span class="harm-desc"    data-i18n="minus-one">-1 to all rolls</span>
                </label>
                <label class="harm-box">
                  <input id="harm-4" type="checkbox" name="attr_harm4" value="1"/>
                  <span class="number-label" data-i18n="4">4</span>
                  <span class="harm-label"   data-i18n="harm">Harm</span>
                  <span class="harm-desc"    data-i18n="minus-one">-1 to all rolls</span>
                </label>
                <label class="harm-box">
                  <input id="harm-5" type="checkbox" name="attr_harm5" value="1"/>
                  <span class="number-label" data-i18n="5">5</span>
                  <span class="harm-label"   data-i18n="serious-harm">Serious harm</span>
                  <span class="harm-desc"    data-i18n="mins-one-die">-1 die to all rolls</span>
                </label>
                <label class="harm-box">
                  <input id="harm-6" type="checkbox" name="attr_harm6" value="1"/>
                  <span class="number-label" data-i18n="6">6</span>
                  <span class="harm-label"   data-i18n="incapacitated">Incapacitated</span>
                  <span class="harm-desc"    data-i18n="taken-out">Taken out</span>
                </label>
            </section>
            
            <section class="specialties-section column-section">
                <label class="column-label" data-i18n="specialties">Specialties</label>
                <fieldset class="repeating_specialties">
                    <input type="number" min="0" name="attr_specialty_num"/>
                    <input type="text" name="attr_specialty_name"/>
                </fieldset>
            </section>
            
        </div>
        
        <div class="col2">
        
            <section class="assets-section column-section">
                <label class="column-label" data-i18n="assets">Assets</label>
                <fieldset class="repeating_assets">
                    <input type="text" name="attr_asset"/>
                </fieldset>
            </section>
            
            <section class="traits-section column-section">
                <label class="column-label" data-i18n="traits">Traits</label>
                <fieldset class="repeating_traits">
                    <input type="text" name="attr_trait"/>
                </fieldset>
            </section>
            
            <section class="talents-section column-section">
                <label class="column-label" data-i18n="talents">Talents</label>
                <fieldset class="repeating_talents">
                    <input type="text" name="attr_talent"/>
                </fieldset>
            </section>
            
            <section class="augments-section column-section">
                <label class="column-label" data-i18n="augments">Auguments</label>
                <fieldset class="repeating_augments">
                    <input type="text" name="attr_augment"/>
                </fieldset>
            </section>
            
        </div>
    </main>
</div> <!-- everything -->
    
